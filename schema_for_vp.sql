create table django_migrations
(
    id      bigint generated by default as identity
        primary key,
    app     varchar(255)             not null,
    name    varchar(255)             not null,
    applied timestamp with time zone not null
);

alter table django_migrations
    owner to admin;

create table django_content_type
(
    id        integer generated by default as identity
        primary key,
    app_label varchar(100) not null,
    model     varchar(100) not null,
    constraint django_content_type_app_label_model_76bd3d3b_uniq
        unique (app_label, model)
);

alter table django_content_type
    owner to admin;

create table auth_permission
(
    id              integer generated by default as identity
        primary key,
    name            varchar(255) not null,
    content_type_id integer      not null
        constraint auth_permission_content_type_id_2f476e4b_fk_django_co
            references django_content_type
            deferrable initially deferred,
    codename        varchar(100) not null,
    constraint auth_permission_content_type_id_codename_01ab375a_uniq
        unique (content_type_id, codename)
);

alter table auth_permission
    owner to admin;


create table auth_group
(
    id   integer generated by default as identity
        primary key,
    name varchar(150) not null
        unique
);

alter table auth_group
    owner to admin;


create table auth_group_permissions
(
    id            bigint generated by default as identity
        primary key,
    group_id      integer not null
        constraint auth_group_permissions_group_id_b120cbf9_fk_auth_group_id
            references auth_group
            deferrable initially deferred,
    permission_id integer not null
        constraint auth_group_permissio_permission_id_84c5c92e_fk_auth_perm
            references auth_permission
            deferrable initially deferred,
    constraint auth_group_permissions_group_id_permission_id_0cd325b0_uniq
        unique (group_id, permission_id)
);

alter table auth_group_permissions
    owner to admin;



create table users_user
(
    id           bigint generated by default as identity
        primary key,
    password     varchar(128)             not null,
    last_login   timestamp with time zone,
    is_superuser boolean                  not null,
    username     varchar(150)             not null
        unique,
    first_name   varchar(150)             not null,
    last_name    varchar(150)             not null,
    is_staff     boolean                  not null,
    is_active    boolean                  not null,
    date_joined  timestamp with time zone not null,
    email        varchar(254)             not null
        unique,
    credits      integer                  not null
        constraint users_user_credits_check
            check (credits >= 0)
);

alter table users_user
    owner to admin;



create table users_user_groups
(
    id       bigint generated by default as identity
        primary key,
    user_id  bigint  not null
        constraint users_user_groups_user_id_5f6f5a90_fk_users_user_id
            references users_user
            deferrable initially deferred,
    group_id integer not null
        constraint users_user_groups_group_id_9afc8d0e_fk_auth_group_id
            references auth_group
            deferrable initially deferred,
    constraint users_user_groups_user_id_group_id_b88eab82_uniq
        unique (user_id, group_id)
);

alter table users_user_groups
    owner to admin;



create table users_user_user_permissions
(
    id            bigint generated by default as identity
        primary key,
    user_id       bigint  not null
        constraint users_user_user_permissions_user_id_20aca447_fk_users_user_id
            references users_user
            deferrable initially deferred,
    permission_id integer not null
        constraint users_user_user_perm_permission_id_0b93982e_fk_auth_perm
            references auth_permission
            deferrable initially deferred,
    constraint users_user_user_permissions_user_id_permission_id_43338c45_uniq
        unique (user_id, permission_id)
);

alter table users_user_user_permissions
    owner to admin;



create table django_admin_log
(
    id              integer generated by default as identity
        primary key,
    action_time     timestamp with time zone not null,
    object_id       text,
    object_repr     varchar(200)             not null,
    action_flag     smallint                 not null
        constraint django_admin_log_action_flag_check
            check (action_flag >= 0),
    change_message  text                     not null,
    content_type_id integer
        constraint django_admin_log_content_type_id_c4bce8eb_fk_django_co
            references django_content_type
            deferrable initially deferred,
    user_id         bigint                   not null
        constraint django_admin_log_user_id_c564eba6_fk_users_user_id
            references users_user
            deferrable initially deferred
);

alter table django_admin_log
    owner to admin;



create table authtoken_token
(
    key     varchar(40)              not null
        primary key,
    created timestamp with time zone not null,
    user_id bigint                   not null
        unique
        constraint authtoken_token_user_id_35299eff_fk_users_user_id
            references users_user
            deferrable initially deferred
);

alter table authtoken_token
    owner to admin;


create table django_session
(
    session_key  varchar(40)              not null
        primary key,
    session_data text                     not null,
    expire_date  timestamp with time zone not null
);

alter table django_session
    owner to admin;



create table adventures_adventure
(
    id                      bigint generated by default as identity
        primary key,
    is_template             boolean                  not null,
    title                   text                     not null,
    description             text                     not null,
    intro                   text                     not null,
    spec_instructions       text                     not null,
    created_at              timestamp with time zone not null,
    updated_at              timestamp with time zone not null,
    author_user_id          bigint                   not null
        constraint adventures_adventure_author_user_id_fb7042ac_fk_users_user_id
            references users_user
            deferrable initially deferred,
    player_user_id          bigint
        constraint adventures_adventure_player_user_id_eefe2df4_fk_users_user_id
            references users_user
            deferrable initially deferred,
    template_adventure_id   bigint
        constraint adventures_adventure_template_adventure_i_395afdb8_fk_adventure
            references adventures_adventure
            deferrable initially deferred,
    primary_hero_id         bigint,
    is_waiting_ai           boolean                  not null,
    rollback_min_history_id bigint,
    constraint adventures_template_or_run_chk
        check ((is_template AND (player_user_id IS NULL) AND (template_adventure_id IS NULL)) OR
               ((NOT is_template) AND (player_user_id IS NOT NULL) AND (template_adventure_id IS NOT NULL)))
);

alter table adventures_adventure
    owner to admin;







create table adventures_faction
(
    id           bigint generated by default as identity
        primary key,
    title        text                     not null,
    description  text                     not null,
    tags         text[]                   not null,
    created_at   timestamp with time zone not null,
    updated_at   timestamp with time zone not null,
    adventure_id bigint                   not null
        constraint adventures_faction_adventure_id_7c93dabf_fk_adventure
            references adventures_adventure
            deferrable initially deferred
);

alter table adventures_faction
    owner to admin;



create table adventures_location
(
    id           bigint generated by default as identity
        primary key,
    title        text                     not null,
    description  text                     not null,
    x            integer                  not null,
    y            integer                  not null,
    width        integer                  not null
        constraint locations_width_gt_zero
            check (width > 0),
    height       integer                  not null
        constraint locations_height_gt_zero
            check (height > 0),
    tags         text[]                   not null,
    created_at   timestamp with time zone not null,
    updated_at   timestamp with time zone not null,
    adventure_id bigint                   not null
        constraint adventures_location_adventure_id_769dd737_fk_adventure
            references adventures_adventure
            deferrable initially deferred
);

alter table adventures_location
    owner to admin;




create table adventures_otherinfo
(
    id           bigint generated by default as identity
        primary key,
    category     text                     not null,
    title        text                     not null,
    description  text                     not null,
    tags         text[]                   not null,
    created_at   timestamp with time zone not null,
    updated_at   timestamp with time zone not null,
    adventure_id bigint                   not null
        constraint adventures_otherinfo_adventure_id_19a4c3e0_fk_adventure
            references adventures_adventure
            deferrable initially deferred
);

alter table adventures_otherinfo
    owner to admin;




create table adventures_race
(
    id           bigint generated by default as identity
        primary key,
    title        text                     not null,
    description  text                     not null,
    tags         text[]                   not null,
    created_at   timestamp with time zone not null,
    updated_at   timestamp with time zone not null,
    adventure_id bigint                   not null
        constraint adventures_race_adventure_id_abd1ab03_fk_adventure
            references adventures_adventure
            deferrable initially deferred,
    life_span    integer                  not null
);

alter table adventures_race
    owner to admin;



create table adventures_adventurehistory
(
    id           bigint generated by default as identity
        primary key,
    role         text                     not null
        constraint history_role_chk
            check (role = ANY (ARRAY ['user'::text, 'ai'::text, 'system'::text])),
    content      text                     not null,
    metadata     jsonb                    not null,
    created_at   timestamp with time zone not null,
    adventure_id bigint                   not null
        constraint adventures_adventure_adventure_id_51b38d0b_fk_adventure
            references adventures_adventure
            deferrable initially deferred
);

alter table adventures_adventurehistory
    owner to admin;



create table adventures_adventurememory
(
    id           bigint generated by default as identity
        primary key,
    kind         text                     not null
        constraint memories_kind_chk
            check (kind = ANY (ARRAY ['summary'::text, 'fact'::text, 'rule'::text, 'goal'::text])),
    title        text                     not null,
    content      text                     not null,
    importance   integer                  not null,
    tags         text[]                   not null,
    created_at   timestamp with time zone not null,
    updated_at   timestamp with time zone not null,
    adventure_id bigint                   not null
        constraint adventures_adventure_adventure_id_83c93aff_fk_adventure
            references adventures_adventure
            deferrable initially deferred
);

alter table adventures_adventurememory
    owner to admin;




create table adventures_character
(
    id                  bigint generated by default as identity
        primary key,
    is_player           boolean                  not null,
    title               text                     not null,
    age                 integer
        constraint characters_age_non_negative
            check ((age >= 0) OR (age IS NULL)),
    body_power          integer                  not null
        constraint characters_body_non_negative
            check (body_power >= 0),
    mind_power          integer                  not null
        constraint characters_mind_non_negative
            check (mind_power >= 0),
    will_power          integer                  not null
        constraint characters_will_non_negative
            check (will_power >= 0),
    description         text                     not null,
    tags                text[]                   not null,
    created_at          timestamp with time zone not null,
    updated_at          timestamp with time zone not null,
    adventure_id        bigint                   not null
        constraint adventures_character_adventure_id_b35f85d9_fk_adventure
            references adventures_adventure
            deferrable initially deferred,
    location_id         bigint
        constraint adventures_character_location_id_4813fe5d_fk_adventure
            references adventures_location
            deferrable initially deferred,
    race_id             bigint
        constraint adventures_character_race_id_952ac4ba_fk_adventures_race_id
            references adventures_race
            deferrable initially deferred,
    in_party            boolean                  not null,
    body_power_progress integer                  not null
        constraint characters_body_progress_range
            check ((body_power_progress >= 0) AND (body_power_progress <= 100)),
    mind_power_progress integer                  not null
        constraint characters_mind_progress_range
            check ((mind_power_progress >= 0) AND (mind_power_progress <= 100)),
    will_power_progress integer                  not null
        constraint characters_will_progress_range
            check ((will_power_progress >= 0) AND (will_power_progress <= 100))
);

alter table adventures_character
    owner to admin;

alter table adventures_adventure
    add constraint adventures_adventure_primary_hero_id_ed8161c1_fk_adventure
        foreign key (primary_hero_id) references adventures_character
            deferrable initially deferred;









create table adventures_characterfaction
(
    id           bigint generated by default as identity
        primary key,
    adventure_id bigint not null
        constraint adventures_character_adventure_id_dc507002_fk_adventure
            references adventures_adventure
            deferrable initially deferred,
    character_id bigint not null
        constraint adventures_character_character_id_02fa92ed_fk_adventure
            references adventures_character
            deferrable initially deferred,
    faction_id   bigint not null
        constraint adventures_character_faction_id_6ac35575_fk_adventure
            references adventures_faction
            deferrable initially deferred,
    constraint uq_characters_factions
        unique (adventure_id, character_id, faction_id)
);

alter table adventures_characterfaction
    owner to admin;






create table adventures_characterrelationship
(
    id                bigint generated by default as identity
        primary key,
    kind              text                     not null,
    description       text                     not null,
    created_at        timestamp with time zone not null,
    updated_at        timestamp with time zone not null,
    adventure_id      bigint                   not null
        constraint adventures_character_adventure_id_1a75dfe7_fk_adventure
            references adventures_adventure
            deferrable initially deferred,
    from_character_id bigint                   not null
        constraint adventures_character_from_character_id_15ffa334_fk_adventure
            references adventures_character
            deferrable initially deferred,
    to_character_id   bigint                   not null
        constraint adventures_character_to_character_id_2db22408_fk_adventure
            references adventures_character
            deferrable initially deferred,
    constraint uq_relationship
        unique (adventure_id, from_character_id, to_character_id, kind),
    constraint rel_not_self
        check (NOT (from_character_id = to_character_id))
);

alter table adventures_characterrelationship
    owner to admin;








create table adventures_skillsystem
(
    id           bigint generated by default as identity
        primary key,
    title        text                     not null,
    description  text                     not null,
    tags         text[]                   not null,
    w_body       integer                  not null,
    w_mind       integer                  not null,
    w_will       integer                  not null,
    formula_hint text                     not null,
    created_at   timestamp with time zone not null,
    updated_at   timestamp with time zone not null,
    adventure_id bigint                   not null
        constraint adventures_skillsyst_adventure_id_1fa42538_fk_adventure
            references adventures_adventure
            deferrable initially deferred,
    constraint skill_systems_weights_nonneg
        check ((w_body >= 0) AND (w_mind >= 0) AND (w_will >= 0)),
    constraint skill_systems_weights_not_all_zero
        check ((w_body > 0) OR (w_mind > 0) OR (w_will > 0))
);

alter table adventures_skillsystem
    owner to admin;




create table adventures_technique
(
    id                    bigint generated by default as identity
        primary key,
    title                 text                     not null,
    description           text                     not null,
    tags                  text[]                   not null,
    difficulty            integer                  not null
        constraint techniques_difficulty_nonneg
            check (difficulty >= 0),
    tier                  integer
        constraint techniques_tier_nonneg
            check ((tier >= 0) OR (tier IS NULL)),
    required_system_level integer                  not null
        constraint techniques_required_level_nonneg
            check (required_system_level >= 0),
    created_at            timestamp with time zone not null,
    updated_at            timestamp with time zone not null,
    adventure_id          bigint                   not null
        constraint adventures_technique_adventure_id_62626f30_fk_adventure
            references adventures_adventure
            deferrable initially deferred,
    system_id             bigint                   not null
        constraint adventures_technique_system_id_71c51bd1_fk_adventure
            references adventures_skillsystem
            deferrable initially deferred
);

alter table adventures_technique
    owner to admin;






create table adventures_charactersystem
(
    id               bigint generated by default as identity
        primary key,
    level            integer not null
        constraint character_system_level_nonneg
            check (level >= 0),
    notes            text    not null,
    adventure_id     bigint  not null
        constraint adventures_character_adventure_id_306f307b_fk_adventure
            references adventures_adventure
            deferrable initially deferred,
    character_id     bigint  not null
        constraint adventures_character_character_id_903681e0_fk_adventure
            references adventures_character
            deferrable initially deferred,
    system_id        bigint  not null
        constraint adventures_character_system_id_3792f8f7_fk_adventure
            references adventures_skillsystem
            deferrable initially deferred,
    progress_percent integer not null
        constraint character_system_progress_pct
            check ((progress_percent >= 0) AND (progress_percent <= 100)),
    constraint uq_character_system
        unique (adventure_id, character_id, system_id)
);

alter table adventures_charactersystem
    owner to admin;






create table adventures_charactertechnique
(
    id           bigint generated by default as identity
        primary key,
    learned_at   timestamp with time zone not null,
    notes        text                     not null,
    adventure_id bigint                   not null
        constraint adventures_character_adventure_id_c08d1b7b_fk_adventure
            references adventures_adventure
            deferrable initially deferred,
    character_id bigint                   not null
        constraint adventures_character_character_id_00f23555_fk_adventure
            references adventures_character
            deferrable initially deferred,
    technique_id bigint                   not null
        constraint adventures_character_technique_id_5d2ea09b_fk_adventure
            references adventures_technique
            deferrable initially deferred,
    constraint uq_character_technique
        unique (adventure_id, character_id, technique_id)
);

alter table adventures_charactertechnique
    owner to admin;






create table adventures_adventureevent
(
    id           bigint generated by default as identity
        primary key,
    status       text                     not null
        constraint events_status_chk
            check (status = ANY (ARRAY ['inactive'::text, 'active'::text, 'resolved'::text])),
    title        text                     not null,
    trigger_hint text                     not null,
    created_at   timestamp with time zone not null,
    updated_at   timestamp with time zone not null,
    adventure_id bigint                   not null
        constraint adventures_adventure_adventure_id_2c9e8aa4_fk_adventure
            references adventures_adventure
            deferrable initially deferred,
    location_id  bigint
        constraint adventures_adventure_location_id_0ec44793_fk_adventure
            references adventures_location
            deferrable initially deferred,
    state        text                     not null
);

alter table adventures_adventureevent
    owner to admin;





create table adventures_adventureherosetup
(
    id                  bigint generated by default as identity
        primary key,
    require_race        boolean not null,
    require_age         boolean not null,
    require_body_power  boolean not null,
    require_mind_power  boolean not null,
    require_will_power  boolean not null,
    require_systems     boolean not null,
    require_techniques  boolean not null,
    adventure_id        bigint  not null
        unique
        constraint adventures_adventure_adventure_id_2da372ec_fk_adventure
            references adventures_adventure
            deferrable initially deferred,
    default_race_id     bigint
        constraint adventures_adventure_default_race_id_623daa87_fk_adventure
            references adventures_race
            deferrable initially deferred,
    default_age         integer
        constraint hero_setup_default_age_nonneg
            check ((default_age >= 0) OR (default_age IS NULL)),
    default_body_power  integer
        constraint hero_setup_default_body_nonneg
            check ((default_body_power >= 0) OR (default_body_power IS NULL)),
    default_mind_power  integer
        constraint hero_setup_default_mind_nonneg
            check ((default_mind_power >= 0) OR (default_mind_power IS NULL)),
    default_will_power  integer
        constraint hero_setup_default_will_nonneg
            check ((default_will_power >= 0) OR (default_will_power IS NULL)),
    default_location_id bigint
        constraint adventures_adventure_default_location_id_03ed22a2_fk_adventure
            references adventures_location
            deferrable initially deferred
);

alter table adventures_adventureherosetup
    owner to admin;




create table users_administrator
(
    id      bigint generated by default as identity
        primary key,
    level   smallint not null
        constraint users_administrator_level_check
            check (level >= 0),
    user_id bigint   not null
        unique
        constraint users_administrator_user_id_b4ab1dd1_fk_users_user_id
            references users_user
            deferrable initially deferred
);

alter table users_administrator
    owner to admin;

create table adventures_moderationentry
(
    adventure_id bigint                   not null
        primary key
        constraint adventures_moderatio_adventure_id_0d9a1072_fk_adventure
            references adventures_adventure
            deferrable initially deferred,
    submitted_at timestamp with time zone not null
);

alter table adventures_moderationentry
    owner to admin;

create table adventures_publishedadventure
(
    adventure_id bigint                   not null
        primary key
        constraint adventures_published_adventure_id_18941941_fk_adventure
            references adventures_adventure
            deferrable initially deferred,
    published_at timestamp with time zone not null
);

alter table adventures_publishedadventure
    owner to admin;

